# Setup

0. Setup ImmuDB https://docs.immudb.io/0.9.2/quickstart.html

1. Delete `data` directories to reset the databases

2. Start multiple ImmuDB instances (with different data directories, and running on different ports). Parameters: https://docs.immudb.io/1.2.1/reference/configuration.html
```
./immudb
./immudb --dir=./data2 --port=3323 --web-server-port=8081 --pgsql-server-port=5433
```
For some reason, the web server still points to the first instance...

3. Delete `.identity-XXXXX` and `.state-XXXXX` files (generated by the clients) if reseted the databases

4. Start multiple ImmuDB clients pointing to the respectives databases
```
./binary_name
./binary_name --config config/config2.env
```

Config files must have the following data:
```
BANK_NAME        string
BANK_ADDRESS     string

DB_IP            string
DB_PORT          int

LIBP2P_TOPIC     string
API_PORT         int

NETWORK          string
CHAIN_ID         string
VERIFIER_ADDRESS string
PRIV_KEY_FILE    string

UPDATE_FREQUENCY int
POLL_FREQUENCY   int

FIND_FREQUENCY   int

LOG_FILE         string
```

Sample:
```
BANK_NAME="Santa Bank"
BANK_ADDRESS="0x7eC027cF7f470983030167d2FACE94745E1AFfE3"

DB_IP="127.0.0.1"
DB_PORT=3322

LIBP2P_TOPIC="ImmuDBTopic"
API_PORT=3301

NETWORK="https://ethereum-holesky.publicnode.com/"
CHAIN_ID="17000"
VERIFIER_ADDRESS="0xff330b4c20d04602f2e522354a1e1d2c91835a7f"
PRIV_KEY_FILE="config/priv_key.txt"

UPDATE_FREQUENCY=60
POLL_FREQUENCY=25

FIND_FREQUENCY=20

LOG_FILE="chain-logs.txt"
```
Private key must be hex encoded, **without** *"0x"* character **nor** quotation marks.

5. Deploy ```blockchainconnector/onchainverfier.go``` on your blockchain network of choice (compiler version 0.5.0)


# APIs

### GET /
Will answer with the bank name and address

### GET /api/health
Will answer ```Up!``` if the server is running


### POST /api/transactions
Provide an array of structs with the following data. *BankTo* field determines whether is an intrabank or interbank transaction:
```
type TransactionsStruct []struct 
{
	UserFrom string `json:"userfrom"`
	Amount   string `json:"amount"`
	UserTo   string `json:"userto"`
	BankTo   string `json:"bankto"`
}
```

Sample: 
```
[
{
    "userfrom": "UserFromIBAN",
    "amount":   "10",
    "userto":   "UserToIBAN",
    "bankto":   "MyOwnBank"
},
{
    "userfrom": "UserFromIBAN",
    "amount":   "2",
    "userto":   "UserToIBAN",
    "bankto":   "CounterpartBank"
},
...
]
```

### POST /api/account-creation
Provide an array of structs with the following data. Correspondent account fields (*isCA*, *isMirror*, *CABank*) will be ignored for now.
```
type Account struct 
{
	Suspended bool    `json:"suspended"`
	Bic       string  `json:"bic"`
	Iban      string  `json:"iban"`
	Balance   float32 `json:"balance"`
	Holder    string  `json:"holder"`
	Currency  string  `json:"currency"`
	IsCA      bool    `json:"isca"`
	IsMirror  bool    `json:"ismirror"`
	CABank    string  `json:"cabank"`
}
```

Sample:
```
[
{
	"suspended": false,
	"bic":       "",
	"iban":      "NewUserIBAN",
	"balance":   15.5,
	"holder":    "NewUserName",
	"currency":  "",
	"isca":      "false",
	"ismirror":  "false",
	"cabank":    ""
},
...
]
```

### POST /api/refill-ca
Refill correspondent account at another bank. Provide an array of structs with the following data.
```
type RefillCAStruct struct {
	Amount string `json:"amount"`
	CABank string `json:"cabank"`
}
```

Sample:
```
[
{
    "amount": "10",
    "cabank": "Test Bank"
},
{
    "amount": "1",
    "cabank": "Test Bank 2"
}
]
```